---
name: 'Restore Environment'
description: 'Restore Python environment and project setup from artifacts'

inputs:
  python-version:
    description: 'Python version to use'
    required: false
    default: '3.12'
  artifacts-dir:
    description: 'Directory for storing all artifacts'
    required: false
    default: 'artifacts'

runs:
  using: 'composite'
  steps:
    - name: Set up Python environment with specified version
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python-version }}

    - name: Restore environment from artifacts and configure Poetry
      shell: bash
      run: |
        set -e
        echo "=== Restoring Environment from Artifacts ==="

        # Verify artifacts exist
        ARTIFACTS_PATH="${{ inputs.artifacts-dir }}"
        if ! test -d "$ARTIFACTS_PATH"; then
            echo "Error: Artifacts directory not found at expected path:"
            echo "  $ARTIFACTS_PATH"
            exit 1
        fi

        ENV_SCRIPT_PATH="$ARTIFACTS_PATH/python-env.sh"
        if ! test -f "$ENV_SCRIPT_PATH"; then
            echo "Error: Environment script not found at expected path:"
            echo "  $ENV_SCRIPT_PATH"
            exit 1
        fi

        # Install Poetry
        echo "Installing Poetry..."
        python -m pip install --upgrade pip
        if ! pip install poetry; then
            echo "Error: Failed to install Poetry"
            exit 1
        fi

        # Source environment and export variables for job
        echo "Sourcing environment configuration..."
        source "$ENV_SCRIPT_PATH"

        echo "ARTIFACTS_DIR=$ARTIFACTS_PATH" >> $GITHUB_ENV
        echo "PROJECT_DIR=$ARTIFACTS_PATH/source" >> $GITHUB_ENV
        echo "VIRTUAL_ENV=${VIRTUAL_ENV}" >> $GITHUB_ENV
        echo "${VIRTUAL_ENV}/bin" >> $GITHUB_PATH

        # Configure Poetry
        echo "Configuring Poetry to use restored virtual environment..."
        poetry config virtualenvs.create false
        poetry config virtualenvs.path "$ARTIFACTS_PATH/venv"

        echo "âœ… Environment restored successfully"
